name: Functions CI

on:
  pull_request:
    paths:
      - "functions/**"
      - "server/**"
      - "src/services/azure.ts"
      - "__tests__/**"
      - ".github/workflows/**"
    branches:
      - "feature/*"
      - "main"

jobs:
  test-functions:
    name: Test Functions (unit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
      - name: Install root deps
        run: npm ci
      - name: Install functions deps
        run: |
          if [ -f functions/package-lock.json ] || [ -f functions/npm-shrinkwrap.json ]; then
            npm ci --prefix functions
          else
            npm install --prefix functions
          fi
      - name: Run repository unit tests (mocked)
        env:
          CI: true
          NODE_ENV: test
        run: npm test -- --ci
      - name: Run functions unit tests (prefix)
        run: npm test --prefix functions || echo "functions package has no tests yet"
